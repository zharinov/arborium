# GENERATED BY: cargo xtask ci generate
# DO NOT EDIT - edit xtask/src/ci.rs instead
---
name: CI
"on": 
  push: 
  pull_request: 
    branches: 
      - main

  merge_group: 
env: 
  CARGO_TERM_COLOR: always
  CARGO_INCREMENTAL: "0"
  CARGO_PROFILE_TEST_DEBUG: "0"

jobs: 
  generate: 
    name: Generate
    runs-on: depot-ubuntu-24.04-32
    container: "ghcr.io/bearcove/arborium-plugin-builder:latest"
    outputs: 
      version: ${{ steps.version.outputs.version }}
      is_release: ${{ steps.version.outputs.is_release }}

    steps: 
      - 
        name: Checkout
        uses: actions/checkout@v4
      - 
        name: Parse version
        run: "set -e\ncase \"$GITHUB_REF\" in\n  refs/tags/v*)\n    VERSION=\"${GITHUB_REF#refs/tags/v}\"\n    IS_RELEASE=\"true\"\n    ;;\n  *)\n    VERSION=\"0.0.0-dev\"\n    IS_RELEASE=\"false\"\n    ;;\nesac\necho \"version=$VERSION\" >> $GITHUB_OUTPUT\necho \"is_release=$IS_RELEASE\" >> $GITHUB_OUTPUT\necho \"Version: $VERSION (release: $IS_RELEASE)\""
        id: version
      - 
        name: Restore grammar generation cache
        uses: actions/cache@v4
        with: 
          path: .cache/arborium
          key: "grammar-cache-v623-${{ hashFiles('langs/group-*/*/def/grammar/grammar.js', 'langs/group-*/*/def/grammar/package.json') }}"
          restore-keys: grammar-cache-v10-

      - 
        name: Generate grammar sources
        run: "set -e\narborium-xtask gen --version ${{ steps.version.outputs.version }}"
      - 
        name: Create grammar sources tarball
        run: "set -e\ntar -cvf grammar-sources.tar crates/ langs/ version.json"
      - 
        name: Upload grammar sources
        uses: actions/upload-artifact@v4
        with: 
          name: grammar-sources
          path: grammar-sources.tar
          retention-days: "1"


  test-linux: 
    name: Test (Linux)
    runs-on: depot-ubuntu-24.04-32
    container: "ghcr.io/bearcove/arborium-plugin-builder:latest"
    needs: 
      - generate

    steps: 
      - 
        name: Checkout
        uses: actions/checkout@v4
      - 
        name: Download grammar sources
        uses: actions/download-artifact@v4
        with: 
          name: grammar-sources
          path: .

      - 
        name: Extract grammar sources
        run: "set -e\ntar -xvf grammar-sources.tar"
      - 
        name: Rust cache
        uses: Swatinem/rust-cache@v2
        with: 
          workspaces: crates/arborium

      - 
        name: Build
        run: "set -e\ncargo build --manifest-path crates/arborium/Cargo.toml --verbose"
      - 
        name: Run tests
        run: "set -e\ncargo nextest run --manifest-path crates/arborium/Cargo.toml --verbose --no-tests=pass"
      - 
        name: Build with all features
        run: "set -e\ncargo build --manifest-path crates/arborium/Cargo.toml --all-features --verbose"

  test-macos: 
    name: Test (macOS)
    runs-on: depot-macos-latest
    needs: 
      - generate

    steps: 
      - 
        name: Checkout
        uses: actions/checkout@v4
      - 
        name: Download grammar sources
        uses: actions/download-artifact@v4
        with: 
          name: grammar-sources
          path: .

      - 
        name: Extract grammar sources
        run: "set -e\ntar -xvf grammar-sources.tar"
      - 
        name: Install Rust
        uses: dtolnay/rust-toolchain@stable
      - 
        name: Rust cache
        uses: Swatinem/rust-cache@v2
        with: 
          workspaces: crates/arborium

      - 
        name: Install nextest
        uses: taiki-e/install-action@v2
        with: 
          tool: cargo-nextest

      - 
        name: Build
        run: "set -e\ncargo build --manifest-path crates/arborium/Cargo.toml --verbose"
      - 
        name: Run tests
        run: "set -e\ncargo nextest run --manifest-path crates/arborium/Cargo.toml --verbose --no-tests=pass"

  wasm: 
    name: WASM Compatibility
    runs-on: depot-ubuntu-24.04-32
    container: "ghcr.io/bearcove/arborium-plugin-builder:latest"
    needs: 
      - generate

    steps: 
      - 
        name: Checkout
        uses: actions/checkout@v4
      - 
        name: Download grammar sources
        uses: actions/download-artifact@v4
        with: 
          name: grammar-sources
          path: .

      - 
        name: Extract grammar sources
        run: "set -e\ntar -xvf grammar-sources.tar"
      - 
        name: Build arborium for WASM
        run: "set -e\ncargo build --manifest-path crates/arborium/Cargo.toml --target wasm32-unknown-unknown --no-default-features"
      - 
        name: Check for env imports in WASM
        run: "set -e\nfound_env_imports=false\nfor wasm_file in $(find target/wasm32-unknown-unknown -name \"*.wasm\" -type f); do\n  if wasm-objdump -j Import -x \"$wasm_file\" 2>/dev/null | grep -q '<- env\\.'; then\n    echo \"ERROR: Found env imports in $wasm_file:\"\n    wasm-objdump -j Import -x \"$wasm_file\" | grep '<- env\\.'\n    found_env_imports=true\n  fi\ndone\nif [ \"$found_env_imports\" = true ]; then\n  echo \"WASM modules should not have env imports - these won't work in the browser\"\n  exit 1\nfi\necho \"No env imports found - WASM modules are browser-compatible\""

  clippy: 
    name: Clippy
    runs-on: depot-ubuntu-24.04-32
    container: "ghcr.io/bearcove/arborium-plugin-builder:latest"
    needs: 
      - generate

    steps: 
      - 
        name: Checkout
        uses: actions/checkout@v4
      - 
        name: Download grammar sources
        uses: actions/download-artifact@v4
        with: 
          name: grammar-sources
          path: .

      - 
        name: Extract grammar sources
        run: "set -e\ntar -xvf grammar-sources.tar"
      - 
        name: Run Clippy
        run: "set -e\ncargo clippy --manifest-path crates/arborium/Cargo.toml --all-targets -- -D warnings"

  docs: 
    name: Documentation
    runs-on: depot-ubuntu-24.04-32
    container: "ghcr.io/bearcove/arborium-plugin-builder:latest"
    needs: 
      - generate

    steps: 
      - 
        name: Checkout
        uses: actions/checkout@v4
      - 
        name: Download grammar sources
        uses: actions/download-artifact@v4
        with: 
          name: grammar-sources
          path: .

      - 
        name: Extract grammar sources
        run: "set -e\ntar -xvf grammar-sources.tar"
      - 
        name: Build docs
        run: "set -e\ncargo doc --manifest-path crates/arborium/Cargo.toml --no-deps"
        env: 
          RUSTDOCFLAGS: "-D warnings"


  build-plugins-acorn: 
    name: "Plugins (acorn): css, html, javascript, json, scss, tsx, typescript, xml"
    runs-on: depot-ubuntu-24.04-32
    container: "ghcr.io/bearcove/arborium-plugin-builder:latest"
    needs: 
      - generate

    steps: 
      - 
        name: Checkout
        uses: actions/checkout@v4
      - 
        name: Download grammar sources
        uses: actions/download-artifact@v4
        with: 
          name: grammar-sources
          path: .

      - 
        name: Extract grammar sources
        run: "set -e\ntar -xvf grammar-sources.tar"
      - 
        name: Build css, html, javascript, json, scss, tsx, typescript, xml
        run: "set -e\narborium-xtask build css html javascript json scss tsx typescript xml -o dist/plugins"
      - 
        name: Upload plugins artifact
        uses: actions/upload-artifact@v4
        with: 
          name: plugins-group-acorn
          path: dist/plugins
          retention-days: "7"


  build-plugins-birch: 
    name: "Plugins (birch): asm, c, cpp, d, go, objc, rust, x86asm, zig"
    runs-on: depot-ubuntu-24.04-32
    container: "ghcr.io/bearcove/arborium-plugin-builder:latest"
    needs: 
      - generate

    steps: 
      - 
        name: Checkout
        uses: actions/checkout@v4
      - 
        name: Download grammar sources
        uses: actions/download-artifact@v4
        with: 
          name: grammar-sources
          path: .

      - 
        name: Extract grammar sources
        run: "set -e\ntar -xvf grammar-sources.tar"
      - 
        name: Build asm, c, cpp, d, go, objc, rust, x86asm, zig
        run: "set -e\narborium-xtask build asm c cpp d go objc rust x86asm zig -o dist/plugins"
      - 
        name: Upload plugins artifact
        uses: actions/upload-artifact@v4
        with: 
          name: plugins-group-birch
          path: dist/plugins
          retention-days: "7"


  build-plugins-cedar: 
    name: "Plugins (cedar): clojure, java, kotlin, scala"
    runs-on: depot-ubuntu-24.04-32
    container: "ghcr.io/bearcove/arborium-plugin-builder:latest"
    needs: 
      - generate

    steps: 
      - 
        name: Checkout
        uses: actions/checkout@v4
      - 
        name: Download grammar sources
        uses: actions/download-artifact@v4
        with: 
          name: grammar-sources
          path: .

      - 
        name: Extract grammar sources
        run: "set -e\ntar -xvf grammar-sources.tar"
      - 
        name: Build clojure, java, kotlin, scala
        run: "set -e\narborium-xtask build clojure java kotlin scala -o dist/plugins"
      - 
        name: Upload plugins artifact
        uses: actions/upload-artifact@v4
        with: 
          name: plugins-group-cedar
          path: dist/plugins
          retention-days: "7"


  build-plugins-fern: 
    name: "Plugins (fern): agda, commonlisp, elixir, elm, erlang, gleam, haskell, idris, lean, ocaml, scheme"
    runs-on: depot-ubuntu-24.04-32
    container: "ghcr.io/bearcove/arborium-plugin-builder:latest"
    needs: 
      - generate

    steps: 
      - 
        name: Checkout
        uses: actions/checkout@v4
      - 
        name: Download grammar sources
        uses: actions/download-artifact@v4
        with: 
          name: grammar-sources
          path: .

      - 
        name: Extract grammar sources
        run: "set -e\ntar -xvf grammar-sources.tar"
      - 
        name: Build agda, commonlisp, elixir, elm, erlang, gleam, haskell, idris, lean, ocaml, scheme
        run: "set -e\narborium-xtask build agda commonlisp elixir elm erlang gleam haskell idris lean ocaml scheme -o dist/plugins"
      - 
        name: Upload plugins artifact
        uses: actions/upload-artifact@v4
        with: 
          name: plugins-group-fern
          path: dist/plugins
          retention-days: "7"


  build-plugins-hazel: 
    name: "Plugins (hazel): awk, bash, batch, fish, lua, perl, php, powershell, python, ruby, zsh"
    runs-on: depot-ubuntu-24.04-32
    container: "ghcr.io/bearcove/arborium-plugin-builder:latest"
    needs: 
      - generate

    steps: 
      - 
        name: Checkout
        uses: actions/checkout@v4
      - 
        name: Download grammar sources
        uses: actions/download-artifact@v4
        with: 
          name: grammar-sources
          path: .

      - 
        name: Extract grammar sources
        run: "set -e\ntar -xvf grammar-sources.tar"
      - 
        name: Build awk, bash, batch, fish, lua, perl, php, powershell, python, ruby, zsh
        run: "set -e\narborium-xtask build awk bash batch fish lua perl php powershell python ruby zsh -o dist/plugins"
      - 
        name: Upload plugins artifact
        uses: actions/upload-artifact@v4
        with: 
          name: plugins-group-hazel
          path: dist/plugins
          retention-days: "7"


  build-plugins-maple: 
    name: "Plugins (maple): caddy, cmake, dockerfile, dot, graphql, hcl, ini, jq, kdl, meson, nginx, ninja, nix, query, ron, sql, ssh-config, toml, yaml"
    runs-on: depot-ubuntu-24.04-32
    container: "ghcr.io/bearcove/arborium-plugin-builder:latest"
    needs: 
      - generate

    steps: 
      - 
        name: Checkout
        uses: actions/checkout@v4
      - 
        name: Download grammar sources
        uses: actions/download-artifact@v4
        with: 
          name: grammar-sources
          path: .

      - 
        name: Extract grammar sources
        run: "set -e\ntar -xvf grammar-sources.tar"
      - 
        name: Build caddy, cmake, dockerfile, dot, graphql, hcl, ini, jq, kdl, meson, nginx, ninja, nix, query, ron, sql, ssh-config, toml, yaml
        run: "set -e\narborium-xtask build caddy cmake dockerfile dot graphql hcl ini jq kdl meson nginx ninja nix query ron sql ssh-config toml yaml -o dist/plugins"
      - 
        name: Upload plugins artifact
        uses: actions/upload-artifact@v4
        with: 
          name: plugins-group-maple
          path: dist/plugins
          retention-days: "7"


  build-plugins-moss: 
    name: "Plugins (moss): ada, glsl, hlsl, julia, matlab, prolog, r, sparql, tlaplus, verilog, vhdl"
    runs-on: depot-ubuntu-24.04-32
    container: "ghcr.io/bearcove/arborium-plugin-builder:latest"
    needs: 
      - generate

    steps: 
      - 
        name: Checkout
        uses: actions/checkout@v4
      - 
        name: Download grammar sources
        uses: actions/download-artifact@v4
        with: 
          name: grammar-sources
          path: .

      - 
        name: Extract grammar sources
        run: "set -e\ntar -xvf grammar-sources.tar"
      - 
        name: Build ada, glsl, hlsl, julia, matlab, prolog, r, sparql, tlaplus, verilog, vhdl
        run: "set -e\narborium-xtask build ada glsl hlsl julia matlab prolog r sparql tlaplus verilog vhdl -o dist/plugins"
      - 
        name: Upload plugins artifact
        uses: actions/upload-artifact@v4
        with: 
          name: plugins-group-moss
          path: dist/plugins
          retention-days: "7"


  build-plugins-pine: 
    name: "Plugins (pine): capnp, dart, devicetree, rescript, starlark, swift, textproto, thrift, uiua, yuri"
    runs-on: depot-ubuntu-24.04-32
    container: "ghcr.io/bearcove/arborium-plugin-builder:latest"
    needs: 
      - generate

    steps: 
      - 
        name: Checkout
        uses: actions/checkout@v4
      - 
        name: Download grammar sources
        uses: actions/download-artifact@v4
        with: 
          name: grammar-sources
          path: .

      - 
        name: Extract grammar sources
        run: "set -e\ntar -xvf grammar-sources.tar"
      - 
        name: Build capnp, dart, devicetree, rescript, starlark, swift, textproto, thrift, uiua, yuri
        run: "set -e\narborium-xtask build capnp dart devicetree rescript starlark swift textproto thrift uiua yuri -o dist/plugins"
      - 
        name: Upload plugins artifact
        uses: actions/upload-artifact@v4
        with: 
          name: plugins-group-pine
          path: dist/plugins
          retention-days: "7"


  build-plugins-sage: 
    name: "Plugins (sage): c-sharp, elisp, fsharp, postscript, vb, vim"
    runs-on: depot-ubuntu-24.04-32
    container: "ghcr.io/bearcove/arborium-plugin-builder:latest"
    needs: 
      - generate

    steps: 
      - 
        name: Checkout
        uses: actions/checkout@v4
      - 
        name: Download grammar sources
        uses: actions/download-artifact@v4
        with: 
          name: grammar-sources
          path: .

      - 
        name: Extract grammar sources
        run: "set -e\ntar -xvf grammar-sources.tar"
      - 
        name: Build c-sharp, elisp, fsharp, postscript, vb, vim
        run: "set -e\narborium-xtask build c-sharp elisp fsharp postscript vb vim -o dist/plugins"
      - 
        name: Upload plugins artifact
        uses: actions/upload-artifact@v4
        with: 
          name: plugins-group-sage
          path: dist/plugins
          retention-days: "7"


  build-plugins-willow: 
    name: "Plugins (willow): asciidoc, diff, jinja2, markdown, svelte, typst, vue"
    runs-on: depot-ubuntu-24.04-32
    container: "ghcr.io/bearcove/arborium-plugin-builder:latest"
    needs: 
      - generate

    steps: 
      - 
        name: Checkout
        uses: actions/checkout@v4
      - 
        name: Download grammar sources
        uses: actions/download-artifact@v4
        with: 
          name: grammar-sources
          path: .

      - 
        name: Extract grammar sources
        run: "set -e\ntar -xvf grammar-sources.tar"
      - 
        name: Build asciidoc, diff, jinja2, markdown, svelte, typst, vue
        run: "set -e\narborium-xtask build asciidoc diff jinja2 markdown svelte typst vue -o dist/plugins"
      - 
        name: Upload plugins artifact
        uses: actions/upload-artifact@v4
        with: 
          name: plugins-group-willow
          path: dist/plugins
          retention-days: "7"


  publish-crates: 
    name: Publish crates.io
    runs-on: depot-ubuntu-24.04-32
    container: "ghcr.io/bearcove/arborium-plugin-builder:latest"
    needs: 
      - generate
      - test-linux
      - test-macos
      - clippy

    if: "startsWith(github.ref, 'refs/tags/v')"
    permissions: 
      id-token: write
      contents: read

    steps: 
      - 
        name: Checkout
        uses: actions/checkout@v4
      - 
        name: Download grammar sources
        uses: actions/download-artifact@v4
        with: 
          name: grammar-sources
          path: .

      - 
        name: Extract grammar sources
        run: "set -e\ntar -xvf grammar-sources.tar"
      - 
        name: Authenticate with crates.io
        uses: rust-lang/crates-io-auth-action@v1
        id: crates-io-auth
      - 
        name: Publish to crates.io
        run: "set -e\narborium-xtask publish crates"
        env: 
          CARGO_REGISTRY_TOKEN: ${{ steps.crates-io-auth.outputs.token }}


  publish-npm: 
    name: Publish npm
    runs-on: depot-ubuntu-24.04-32
    container: "ghcr.io/bearcove/arborium-plugin-builder:latest"
    needs: 
      - generate
      - build-plugins-acorn
      - build-plugins-birch
      - build-plugins-cedar
      - build-plugins-fern
      - build-plugins-hazel
      - build-plugins-maple
      - build-plugins-moss
      - build-plugins-pine
      - build-plugins-sage
      - build-plugins-willow

    if: "startsWith(github.ref, 'refs/tags/v')"
    permissions: 
      id-token: write
      contents: read

    steps: 
      - 
        name: Checkout
        uses: actions/checkout@v4
      - 
        name: Download grammar sources
        uses: actions/download-artifact@v4
        with: 
          name: grammar-sources
          path: .

      - 
        name: Extract grammar sources
        run: "set -e\ntar -xvf grammar-sources.tar"
      - 
        name: Setup Node.js
        uses: actions/setup-node@v4
        with: 
          node-version: "20"
          registry-url: "https://registry.npmjs.org"

      - 
        name: Download plugins group acorn
        uses: actions/download-artifact@v4
        with: 
          name: plugins-group-acorn
          path: dist/plugins

      - 
        name: Download plugins group birch
        uses: actions/download-artifact@v4
        with: 
          name: plugins-group-birch
          path: dist/plugins

      - 
        name: Download plugins group cedar
        uses: actions/download-artifact@v4
        with: 
          name: plugins-group-cedar
          path: dist/plugins

      - 
        name: Download plugins group fern
        uses: actions/download-artifact@v4
        with: 
          name: plugins-group-fern
          path: dist/plugins

      - 
        name: Download plugins group hazel
        uses: actions/download-artifact@v4
        with: 
          name: plugins-group-hazel
          path: dist/plugins

      - 
        name: Download plugins group maple
        uses: actions/download-artifact@v4
        with: 
          name: plugins-group-maple
          path: dist/plugins

      - 
        name: Download plugins group moss
        uses: actions/download-artifact@v4
        with: 
          name: plugins-group-moss
          path: dist/plugins

      - 
        name: Download plugins group pine
        uses: actions/download-artifact@v4
        with: 
          name: plugins-group-pine
          path: dist/plugins

      - 
        name: Download plugins group sage
        uses: actions/download-artifact@v4
        with: 
          name: plugins-group-sage
          path: dist/plugins

      - 
        name: Download plugins group willow
        uses: actions/download-artifact@v4
        with: 
          name: plugins-group-willow
          path: dist/plugins

      - 
        name: List plugins
        run: "set -e\nfind dist/plugins -name 'package.json' | head -20"
      - 
        name: Publish to npm
        run: "set -e\narborium-xtask publish npm -o dist/plugins"
        env: 
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}



