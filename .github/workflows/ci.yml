# GENERATED BY: cargo xtask ci generate
# DO NOT EDIT - edit xtask/src/ci.rs instead
---
name: CI
"on": 
  push: 
    branches: 
      - main

    tags: 
      - v*

  pull_request: 
    branches: 
      - main

  merge_group: 
env: 
  CARGO_TERM_COLOR: always
  CARGO_INCREMENTAL: "0"
  CARGO_PROFILE_TEST_DEBUG: "0"

jobs: 
  generate: 
    name: Generate
    runs-on: depot-ubuntu-24.04-32
    container: "ghcr.io/bearcove/arborium-plugin-builder:latest"
    outputs: 
      version: ${{ steps.version.outputs.version }}
      is_release: ${{ steps.version.outputs.is_release }}

    steps: 
      - 
        name: Checkout
        uses: actions/checkout@v4
      - 
        name: Parse version
        run: "if [[ \"$GITHUB_REF\" == refs/tags/v* ]]; then\n  VERSION=\"${GITHUB_REF#refs/tags/v}\"\n  IS_RELEASE=\"true\"\nelse\n  VERSION=\"0.0.0-dev\"\n  IS_RELEASE=\"false\"\nfi\necho \"version=$VERSION\" >> $GITHUB_OUTPUT\necho \"is_release=$IS_RELEASE\" >> $GITHUB_OUTPUT\necho \"Version: $VERSION (release: $IS_RELEASE)\""
        id: version
      - 
        name: Restore grammar generation cache
        uses: actions/cache@v4
        with: 
          path: .cache/arborium
          key: "grammar-cache-v2-${{ hashFiles('crates/*/grammar/grammar.js', 'crates/*/grammar/package.json', 'crates/*/common/**') }}"
          restore-keys: grammar-cache-v2-

      - 
        name: Generate grammar sources
        run: arborium-xtask gen --version ${{ steps.version.outputs.version }}
      - 
        name: Create grammar sources tarball
        run: "{\n  # Root workspace Cargo.toml (has workspace dependency versions)\n  echo \"Cargo.toml\"\n  # Main arborium crate Cargo.toml (has dependency versions)\n  echo \"crates/arborium/Cargo.toml\"\n  # Grammar crates (only those with a grammar/ directory)\n  for d in crates/arborium-*/; do\n    if [ -d \"$d/grammar\" ]; then\n      echo \"${d}Cargo.toml\"\n      echo \"${d}src\"\n      echo \"${d}grammar/src\"\n    fi\n  done\n} > generated_files.txt\ntar -cvf grammar-sources.tar -T generated_files.txt"
      - 
        name: Upload grammar sources
        uses: actions/upload-artifact@v4
        with: 
          name: grammar-sources
          path: grammar-sources.tar
          retention-days: "1"


  test-linux: 
    name: Test (Linux)
    runs-on: depot-ubuntu-24.04-32
    container: "ghcr.io/bearcove/arborium-plugin-builder:latest"
    needs: 
      - generate

    steps: 
      - 
        name: Checkout
        uses: actions/checkout@v4
      - 
        name: Download grammar sources
        uses: actions/download-artifact@v4
        with: 
          name: grammar-sources

      - 
        name: Extract grammar sources
        run: tar -xvf grammar-sources.tar
      - 
        name: Build
        run: cargo build --locked --verbose
      - 
        name: Run tests
        run: cargo nextest run --locked --verbose
      - 
        name: Build with all features
        run: cargo build --locked --all-features --verbose

  test-macos: 
    name: Test (macOS)
    runs-on: depot-macos-latest
    needs: 
      - generate

    steps: 
      - 
        name: Checkout
        uses: actions/checkout@v4
      - 
        name: Download grammar sources
        uses: actions/download-artifact@v4
        with: 
          name: grammar-sources

      - 
        name: Extract grammar sources
        run: tar -xvf grammar-sources.tar
      - 
        name: Install Rust
        uses: dtolnay/rust-toolchain@stable
      - 
        name: Rust cache
        uses: Swatinem/rust-cache@v2
      - 
        name: Install nextest
        uses: taiki-e/install-action@v2
        with: 
          tool: cargo-nextest

      - 
        name: Build
        run: cargo build --locked --verbose
      - 
        name: Run tests
        run: cargo nextest run --locked --verbose

  wasm: 
    name: WASM Compatibility
    runs-on: depot-ubuntu-24.04-32
    container: "ghcr.io/bearcove/arborium-plugin-builder:latest"
    needs: 
      - generate

    steps: 
      - 
        name: Checkout
        uses: actions/checkout@v4
      - 
        name: Download grammar sources
        uses: actions/download-artifact@v4
        with: 
          name: grammar-sources

      - 
        name: Extract grammar sources
        run: tar -xvf grammar-sources.tar
      - 
        name: Build arborium for WASM
        run: cargo build --locked -p arborium --target wasm32-unknown-unknown
      - 
        name: Check for env imports in WASM
        run: "found_env_imports=false\nfor wasm_file in $(find target/wasm32-unknown-unknown -name \"*.wasm\" -type f); do\n  if wasm-objdump -j Import -x \"$wasm_file\" 2>/dev/null | grep -q '<- env\\.'; then\n    echo \"ERROR: Found env imports in $wasm_file:\"\n    wasm-objdump -j Import -x \"$wasm_file\" | grep '<- env\\.'\n    found_env_imports=true\n  fi\ndone\nif [ \"$found_env_imports\" = true ]; then\n  echo \"WASM modules should not have env imports - these won't work in the browser\"\n  exit 1\nfi\necho \"No env imports found - WASM modules are browser-compatible\""

  clippy: 
    name: Clippy
    runs-on: depot-ubuntu-24.04-32
    container: "ghcr.io/bearcove/arborium-plugin-builder:latest"
    needs: 
      - generate

    steps: 
      - 
        name: Checkout
        uses: actions/checkout@v4
      - 
        name: Download grammar sources
        uses: actions/download-artifact@v4
        with: 
          name: grammar-sources

      - 
        name: Extract grammar sources
        run: tar -xvf grammar-sources.tar
      - 
        name: Run Clippy
        run: cargo clippy --locked --all-targets -- -D warnings

  fmt: 
    name: Format
    runs-on: depot-ubuntu-24.04-4
    container: "ghcr.io/bearcove/arborium-plugin-builder:latest"
    steps: 
      - 
        name: Checkout
        uses: actions/checkout@v4
      - 
        name: Check formatting
        run: cargo fmt --all -- --check
      - 
        name: Check CI workflow is up to date
        run: arborium-xtask ci generate --check

  docs: 
    name: Documentation
    runs-on: depot-ubuntu-24.04-32
    container: "ghcr.io/bearcove/arborium-plugin-builder:latest"
    needs: 
      - generate

    steps: 
      - 
        name: Checkout
        uses: actions/checkout@v4
      - 
        name: Download grammar sources
        uses: actions/download-artifact@v4
        with: 
          name: grammar-sources

      - 
        name: Extract grammar sources
        run: tar -xvf grammar-sources.tar
      - 
        name: Build docs
        run: cargo doc --locked --no-deps
        env: 
          RUSTDOCFLAGS: "-D warnings"


  build-plugins-0: 
    name: "Plugins (1/2): rust"
    runs-on: depot-ubuntu-24.04-32
    container: "ghcr.io/bearcove/arborium-plugin-builder:latest"
    needs: 
      - generate

    steps: 
      - 
        name: Checkout
        uses: actions/checkout@v4
      - 
        name: Download grammar sources
        uses: actions/download-artifact@v4
        with: 
          name: grammar-sources

      - 
        name: Extract grammar sources
        run: tar -xvf grammar-sources.tar
      - 
        name: Build rust
        run: arborium-xtask plugins build rust
      - 
        name: Generate npm package.json
        run: arborium-xtask plugins npm --version ${{ needs.generate.outputs.version }}
      - 
        name: Upload plugins artifact
        uses: actions/upload-artifact@v4
        with: 
          name: plugins-group-0
          path: dist/plugins
          retention-days: "7"


  build-plugins-1: 
    name: "Plugins (2/2): javascript, html"
    runs-on: depot-ubuntu-24.04-32
    container: "ghcr.io/bearcove/arborium-plugin-builder:latest"
    needs: 
      - generate

    steps: 
      - 
        name: Checkout
        uses: actions/checkout@v4
      - 
        name: Download grammar sources
        uses: actions/download-artifact@v4
        with: 
          name: grammar-sources

      - 
        name: Extract grammar sources
        run: tar -xvf grammar-sources.tar
      - 
        name: Build javascript, html
        run: arborium-xtask plugins build javascript html
      - 
        name: Generate npm package.json
        run: arborium-xtask plugins npm --version ${{ needs.generate.outputs.version }}
      - 
        name: Upload plugins artifact
        uses: actions/upload-artifact@v4
        with: 
          name: plugins-group-1
          path: dist/plugins
          retention-days: "7"


  publish-crates: 
    name: Publish crates.io
    runs-on: depot-ubuntu-24.04-32
    container: "ghcr.io/bearcove/arborium-plugin-builder:latest"
    needs: 
      - generate
      - test-linux
      - test-macos
      - clippy

    if: "startsWith(github.ref, 'refs/tags/v')"
    steps: 
      - 
        name: Checkout
        uses: actions/checkout@v4
      - 
        name: Download grammar sources
        uses: actions/download-artifact@v4
        with: 
          name: grammar-sources

      - 
        name: Extract grammar sources
        run: tar -xvf grammar-sources.tar
      - 
        name: Publish to crates.io
        run: arborium-xtask publish crates
        env: 
          CARGO_REGISTRY_TOKEN: ${{ secrets.CARGO_REGISTRY_TOKEN }}


  publish-npm: 
    name: Publish npm
    runs-on: ubuntu-latest
    needs: 
      - generate
      - build-plugins-0
      - build-plugins-1

    if: "startsWith(github.ref, 'refs/tags/v')"
    steps: 
      - 
        name: Checkout
        uses: actions/checkout@v4
      - 
        name: Setup Node.js
        uses: actions/setup-node@v4
        with: 
          node-version: "20"
          registry-url: "https://registry.npmjs.org"

      - 
        name: Download plugins group 0
        uses: actions/download-artifact@v4
        with: 
          name: plugins-group-0
          path: dist/plugins

      - 
        name: Download plugins group 1
        uses: actions/download-artifact@v4
        with: 
          name: plugins-group-1
          path: dist/plugins

      - 
        name: List plugins
        run: "find dist/plugins -name 'package.json' | head -20"
      - 
        name: Install Rust
        uses: dtolnay/rust-toolchain@stable
      - 
        name: Rust cache
        uses: Swatinem/rust-cache@v2
      - 
        name: Build xtask
        run: cargo build --release -p xtask
      - 
        name: Publish to npm
        run: ./target/release/xtask publish npm -o dist/plugins
        env: 
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}



