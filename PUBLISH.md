# Publishing Guide

## The New Paradigm

**The git tag is the single source of truth for versions.**

- Locally, versions are `0.0.0-dev` - they don't matter
- CI parses the version from the tag (e.g., `v0.3.0` → `0.3.0`)
- CI runs `xtask gen --version 0.3.0` which sets all versions
- Then CI publishes everything

This means:
- No version drift or mismatch issues
- No "forgot to bump version" mistakes
- No chore commits for version bumps
- Clean, simple workflow

## What's in Git vs Generated

### Committed to Git (source of truth)

```
crates/arborium-{lang}/
├── arborium.kdl          ← SOURCE OF TRUTH (grammar config, license, metadata)
├── grammar/
│   ├── grammar.js        ← tree-sitter grammar definition
│   └── scanner.c         ← custom scanner (if any)
├── queries/
│   └── highlights.scm    ← highlight queries
└── samples/              ← test samples
```

### Generated (gitignored)

```
crates/arborium-{lang}/
├── Cargo.toml            ← GENERATED by xtask gen
├── build.rs              ← GENERATED by xtask gen
├── src/lib.rs            ← GENERATED by xtask gen
└── grammar/
    └── src/              ← GENERATED by xtask gen (tree-sitter generate)
        ├── parser.c
        ├── grammar.json
        └── ...
```

### Non-generated crates (hand-written, committed)

These crates don't have `arborium.kdl` and are fully hand-written:
- `arborium` (main crate)
- `arborium-test-harness`
- `arborium-sysroot`
- `arborium-host`
- `arborium-wire`
- `arborium-plugin-runtime`
- `miette-arborium`

## Version Sources

| What | Source |
|------|--------|
| All crate versions | `xtask gen --version X.Y.Z` (from git tag in CI) |
| Grammar license | `arborium.kdl` `license` field |
| npm package versions | `--version` flag passed to `xtask plugins npm` |

## Workflows

### Local Development

```bash
# Edit arborium.kdl, grammar.js, queries, etc.

# Regenerate (uses 0.0.0-dev version, doesn't matter locally)
cargo xtask gen

# Build and test
cargo build
cargo test
```

### CI Build (ci.yml)

```bash
# Checkout
# Regenerate everything (version doesn't matter for CI checks)
cargo xtask gen

# Build & test
cargo build
cargo test
```

### Release (tag push)

```bash
# 1. Create and push tag
git tag v0.3.0
git push origin v0.3.0

# 2. CI (release.yml) does:
VERSION=${GITHUB_REF#refs/tags/v}  # "0.3.0"
cargo xtask gen --version $VERSION  # Sets all versions to 0.3.0
cargo xtask pack create             # Tar up generated grammar/src/* files
# ... publish job downloads artifact, extracts, publishes
cargo publish --workspace
```

### npm Publish (npm-publish.yml)

```bash
# Triggered by tag or manual with version input
VERSION=0.3.0
cargo xtask gen --version $VERSION
cargo xtask plugins build
cargo xtask plugins npm --version $VERSION
npm publish ...
```

## What `xtask gen --version X.Y.Z` Does

1. **Updates root `Cargo.toml`:**
   - `[workspace.package] version = "X.Y.Z"`
   - All `[workspace.dependencies]` version fields

2. **Generates grammar crate files:**
   - `Cargo.toml` with version `X.Y.Z` and license from `arborium.kdl`
   - `build.rs` with correct C compilation setup
   - `src/lib.rs` with language exports
   - `grammar/src/*` via tree-sitter generate

When called without `--version`, uses `0.0.0-dev` (fine for local dev since path deps ignore versions).

## Artifacts Published

| Registry | Package | Workflow |
|----------|---------|----------|
| crates.io | `arborium` | release.yml |
| crates.io | `arborium-test-harness` | release.yml |
| crates.io | `arborium-sysroot` | release.yml |
| crates.io | `arborium-{lang}` (98 crates) | release.yml |
| crates.io | `tree-sitter-patched-arborium` | release.yml |
| crates.io | `tree-sitter-highlight-patched-arborium` | release.yml |
| crates.io | `miette-arborium` | release.yml |
| npmjs.com | `@arborium/arborium` | npm-publish.yml |
| npmjs.com | `@arborium/grammar-{lang}` | npm-publish.yml |
| ghcr.io | `arborium-plugin-builder` | manual (`just docker-push`) |

## Local Publishing (testing)

If you need to test publishing locally:

```bash
# Set version explicitly
cargo xtask gen --version 0.3.0

# Dry-run publish
cargo publish -p arborium-rust --dry-run
```
