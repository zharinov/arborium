#!/usr/bin/env bash
set -euo pipefail

REPO_ROOT="$(cd "$(dirname "$0")/.." && pwd)"
HOOKS_DIR="$REPO_ROOT/.git/hooks"

echo "Installing git hooks..."

cat > "$HOOKS_DIR/pre-push" << 'EOF'
#!/usr/bin/env bash
set -euo pipefail

echo "Running pre-push checks..."

echo "  Checking formatting..."
cargo fmt --check

echo "  Running clippy..."
cargo clippy --all-targets --all-features -- -D warnings

echo "Pre-push checks passed!"
EOF

chmod +x "$HOOKS_DIR/pre-push"

echo "Installed pre-push hook to $HOOKS_DIR/pre-push"

cat > "$HOOKS_DIR/pre-commit" << 'EOF'
#!/usr/bin/env node

const { execSync } = require('child_process');

// Get list of staged files before formatting
const stagedFiles = execSync('git diff --cached --name-only --diff-filter=ACM', { encoding: 'utf-8' })
  .trim()
  .split('\n')
  .filter(f => f.length > 0);

if (stagedFiles.length === 0) {
  process.exit(0);
}

console.log('Running cargo fmt...');

try {
  execSync('cargo fmt', { stdio: 'inherit' });
} catch (e) {
  console.error('cargo fmt failed');
  process.exit(1);
}

// Re-stage files that were originally staged (in case cargo fmt modified them)
const rustFiles = stagedFiles.filter(f => f.endsWith('.rs'));
if (rustFiles.length > 0) {
  console.log('Re-staging formatted files...');
  execSync(`git add ${rustFiles.map(f => `"${f}"`).join(' ')}`, { stdio: 'inherit' });
}

console.log('Pre-commit checks passed!');
EOF

chmod +x "$HOOKS_DIR/pre-commit"

echo "Installed pre-commit hook to $HOOKS_DIR/pre-commit"
